# This workflow will deploy to S3 with static site in place
name: Build and deploy package releases
on:
    workflow_dispatch:

    workflow_call:
        inputs:
            ref:
                required: false
                type: string
                description: 'The commit SHA to checkout'

    # push:
    #   branches:
    #     - 'main'
    #   paths:
    #     - 'src/**'
    #     - 'static/*'

jobs:
    validate:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        strategy:
            matrix:
                node-version: [24.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ inputs.ref }}

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install app
              run: npm install

            - name: Lint app
              run: npm run lint:check

            - name: check format
              run: npm run format:check

    publish-win-release:
        needs: [validate]
        runs-on: windows-latest
        permissions:
            contents: read

        env:
            WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}

        strategy:
            matrix:
                node-version: [24.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ inputs.ref }}

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install
              run: npm install

            - name: Setup code signing certificate
              run: |
                  # Create build directory
                  New-Item -ItemType Directory -Force -Path "build"

                  # Decode certificate from secret and save to file
                  $certBytes = [System.Convert]::FromBase64String("$env:WINDOWS_CERTIFICATE")
                  [System.IO.File]::WriteAllBytes("$PWD\build\applitest-cert.p12", $certBytes)

                  Write-Host "Certificate file created successfully"
              shell: pwsh
              if: env.WINDOWS_CERTIFICATE != ''

            - name: Build for production (with signing)
              run: npm run build:win
              if: env.WINDOWS_CERTIFICATE != ''

            - name: Build for production (without signing)
              run: |
                  # Temporarily disable signing for build without certificate
                  $packageJson = Get-Content "package.json" | ConvertFrom-Json
                  $packageJson.build.win.signAndEditExecutable = $false
                  $packageJson | ConvertTo-Json -Depth 100 | Set-Content "package.json"
                  npm run build:win
              shell: pwsh
              if: env.WINDOWS_CERTIFICATE == ''

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET }}
                  aws-region: eu-west-1

            - name: Deploy to S3
              run: |
                  echo "Copy to sync folder"
                  mkdir -p ./dist/sync
                  cp ./dist/ApplitestLocalRunner* ./dist/sync
                  echo "Syncing to S3"
                  aws s3 sync ./dist/sync s3://${{ vars.AWS_S3 }}/downloads
                  aws cloudfront create-invalidation --distribution-id=${{ vars.AWS_CLOUDFRONT }}  --paths "/downloads/*"

    publish-macos-release:
        needs: [validate]
        runs-on: macos-latest
        permissions:
            contents: read

        strategy:
            matrix:
                node-version: [24.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ inputs.ref }}

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install
              run: npm install

            - name: Build for production (unsigned)
              env:
                  USE_HARD_LINKS: false
              run: |
                  echo "Building macOS application for CI..."
                  npm run build:mac

            - name: Ad-hoc sign the application
              run: |
                  echo "Ad-hoc signing the application to prevent macOS Gatekeeper issues..."

                  # Find the .app bundle
                  APP_PATH=$(find dist -name "*.app" -type d | head -n 1)

                  if [ -z "$APP_PATH" ]; then
                      echo "❌ No .app bundle found"
                      exit 1
                  fi

                  echo "Found app at: $APP_PATH"

                  # Ad-hoc sign the app bundle with deep signing
                  codesign --force --deep --sign - "$APP_PATH"

                  echo "✅ App signed successfully"

                  # Verify the signature
                  codesign -dv --verbose=4 "$APP_PATH"

                  # Also sign any DMG that was created
                  DMG_PATH=$(find dist -name "*.dmg" -type f | head -n 1)
                  if [ -n "$DMG_PATH" ]; then
                      echo "Signing DMG at: $DMG_PATH"
                      codesign --force --sign - "$DMG_PATH"
                      echo "✅ DMG signed successfully"
                  fi

            - name: Verify build after creation
              run: |
                  echo "Checking if app was built..."
                  if [ -f "dist/ApplitestLocalRunner-mac.dmg" ]; then
                      echo "✅ App built successfully"
                      echo "Checking signature status..."
                      codesign -dv --verbose=4 "dist/ApplitestLocalRunner-mac.dmg" || echo "Signature check failed"
                      ls -la "dist/"
                  else
                      echo "❌ App not found in expected location, listing dist contents..."
                      find dist -name "*.app" -type d || echo "No .app bundles found"
                      find dist -name "*.dmg" -type f || echo "No .dmg files found"
                  fi

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET }}
                  aws-region: eu-west-1

            - name: Deploy to S3
              run: |
                  echo "Copy to sync folder"
                  mkdir -p ./dist/sync
                  cp ./dist/ApplitestLocalRunner-mac.dmg ./dist/sync/ApplitestLocalRunner-macos13.dmg
                  echo "Syncing to S3"
                  aws s3 sync ./dist/sync s3://${{ vars.AWS_S3 }}/downloads
                  aws cloudfront create-invalidation --distribution-id=${{ vars.AWS_CLOUDFRONT }}  --paths "/downloads/*"

    # publish-macoslatest-release:
    #     needs: [validate, publish-macos13-release]
    #     runs-on: macos-latest

    #     strategy:
    #         matrix:
    #             node-version: [20.x]
    #             # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    #     steps:
    #         - uses: actions/checkout@v4

    #         - name: Use Node.js ${{ matrix.node-version }}
    #           uses: actions/setup-node@v4
    #           with:
    #               node-version: ${{ matrix.node-version }}
    #               cache: 'npm'

    #         - name: Install
    #           run: npm install

    #         - name: Build for production
    #           env:
    #               USE_HARD_LINKS: false
    #           run: npm run build:mac

    #         - name: Configure AWS Credentials
    #           uses: aws-actions/configure-aws-credentials@v4
    #           with:
    #               aws-access-key-id: ${{ secrets.AWS_ACCESS }}
    #               aws-secret-access-key: ${{ secrets.AWS_SECRET }}
    #               aws-region: eu-west-1

    #         - name: Deploy to S3
    #           run: |
    #               echo "Copy to sync folder"
    #               mkdir -p ./dist/sync
    #               cp ./dist/ApplitestLocalRunner-mac.dmg ./dist/sync/ApplitestLocalRunner-macos-arm64.dmg
    #               echo "Syncing to S3"
    #               aws s3 sync ./dist/sync s3://${{ vars.AWS_S3 }}/downloads
    #               aws cloudfront create-invalidation --distribution-id=${{ vars.AWS_CLOUDFRONT }}  --paths "/downloads/*"
